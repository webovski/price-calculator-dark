<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конфигуратор</title>
    <link rel="stylesheet" type="text/css" href="./assets/styles.css">
</head>
<body>
<h1 id="title">Конфигуратор</h1>
<h2 id="subtitle">Настройте рекламу под Ваш бюджет</h2>

<div class="slider-container">
    <label for="chat-range" id="label-range">Выберите охват:</label>
    <input type="range" id="chat-range" min="1" value="1" step="1">

    <!-- Separate spans for output-chats and output-price -->
    <div class="output" id="output-chats">
        <span id="label-chats">Число чатов: </span><span id="selected-chats">1</span>
    </div>
    <div class="output" id="output-users">
        <span id="label-users">Вашу рекламу увидит </span><span id="audience-count">0</span>
    </div>
    <div class="output" id="output-price">
        <span id="label-price">Стоимость: $</span><span id="total-price">0.00</span>
    </div>
    <div class="tip" id="discount-tip">
        <span id="label-discount">Скидка: </span><span id="discount-value">0%</span>
    </div>
</div>

<div class="chat-list" id="chat-list">
    <!-- Chat items will be dynamically added here -->
</div>

<!-- Language Switcher (Flag icons) -->
<div class="lang-switcher">
    <img src="https://flagcdn.com/w20/ru.png" srcset="https://flagcdn.com/w40/ru.png 2x" id="lang-ru" onclick="changeLanguage('ru')" width="20" alt="Russia">
    <img src="https://flagcdn.com/w20/us.png" srcset="https://flagcdn.com/w40/us.png 2x" id="lang-en" onclick="changeLanguage('en')" width="20" alt="English">
    <img src="https://flagcdn.com/w20/ua.png" srcset="https://flagcdn.com/w40/ua.png 2x" id="lang-ua" onclick="changeLanguage('ua')" width="20" alt="Ukraine">
</div>

<script>
    // Language data
    const langData = {
        ru: {
            title: "Конфигуратор",
            subtitle: "Настройте рекламу под Ваш бюджет",
            labelRange: "Выберите охват:",
            outputChats: "Число чатов: ",
            outputUsers: "Вашу рекламу увидит ",
            outputPrice: "Стоимость: $",
            discountTip: "Скидка: ",
            participants: "человек",
        },
        en: {
            title: "Configurator",
            subtitle: "Adjust the ad for your budget",
            labelRange: "Select reach:",
            outputChats: "Number of chats: ",
            outputUsers: "Your ad will be seen by ",
            outputPrice: "Cost: $",
            discountTip: "Discount: ",
            participants: "people",
        },
        ua: {
            title: "Конфігуратор",
            subtitle: "Налаштуйте рекламу під Ваш бюджет",
            labelRange: "Виберіть охоплення:",
            outputChats: "Кількість чатів: ",
            outputUsers: "Вашу рекламу побачать ",
            outputPrice: "Вартість: $",
            discountTip: "Знижка: ",
            participants: "користувачів",
        }
    };

    let currentLang = 'ru';  // Default language is Russian (ru)

    const discountTiers = [
        { maxUsers: 100000, rate: 0.0016 },
        { maxUsers: 250000, rate: 0.0013 },
        { maxUsers: 500000, rate: 0.001 },
        { maxUsers: 750000, rate: 0.0007 },
        { maxUsers: 1000000, rate: 0.0005 },
        { maxUsers: 1500000, rate: 0.00035 },
    ];

    let chats = []; // Variable to hold chat data

    // Select DOM elements
    const chatRange = document.getElementById('chat-range');
    const selectedChats = document.getElementById('selected-chats');
    const audienceCount = document.getElementById('audience-count');
    const totalPrice = document.getElementById('total-price');
    const discountTip = document.getElementById('discount-tip');
    const chatList = document.getElementById('chat-list');
    const title = document.getElementById('title');
    const subtitle = document.getElementById('subtitle');
    const labelRange = document.getElementById('label-range');
    const labelChats = document.getElementById('label-chats');
    const labelUsers = document.getElementById('label-users');
    const labelPrice = document.getElementById('label-price');
    const labelDiscount = document.getElementById('label-discount');

    // Fetch the chats.txt file from the server
    fetch('chats.txt')
        .then(response => response.text())
        .then(data => {
            parseChatData(data);  // Parse the content of the file
            updateStats();  // Update stats after data is loaded
        })
        .catch(error => {
            console.error('Error fetching the chat file:', error);
        });

    // Parse chat data from the fetched text file
    function parseChatData(text) {
        const lines = text.split('\n');
        chats = lines.map(line => {
            const [username, members] = line.split(':');
            return { username: username.trim(), members: parseInt(members.trim()) };
        });

        // Sort chats by number of members descending
        chats.sort((a, b) => b.members - a.members);

        // Set max range to the total number of chats
        chatRange.max = chats.length;
    }

    // Calculate cost per user based on discount tiers
    function calculateCost(users) {
        let totalCost = 0;
        let remainingUsers = users;

        for (const tier of discountTiers) {
            if (remainingUsers <= 0) break;

            const tierUsers = Math.min(remainingUsers, tier.maxUsers);
            totalCost += tierUsers * tier.rate;
            remainingUsers -= tierUsers;
        }

        return totalCost;
    }

    // Get discount percentage based on current cost per user
    function getDiscountPercentage(totalCost, users) {
        const baseCost = users * discountTiers[0].rate; // Without discount
        return Math.round((1 - totalCost / baseCost) * 100);
    }

    // Update chats and stats dynamically
    function updateStats() {
        const chatCount = parseInt(chatRange.value, 10) || 1;
        const selectedChatsList = chats.slice(0, chatCount);

        const totalUsers = selectedChatsList.reduce((sum, chat) => sum + chat.members, 0);
        const totalCost = calculateCost(totalUsers);

        // Update UI after recalculating values
        selectedChats.textContent = chatCount;
        audienceCount.textContent = `${totalUsers.toLocaleString()} ${langData[currentLang].participants}`;
        totalPrice.textContent = totalCost.toFixed(2);
        discountTip.textContent = `${langData[currentLang].discountTip} ${getDiscountPercentage(totalCost, totalUsers)}%`;

        // Update chat list dynamically
        chatList.innerHTML = selectedChatsList.map(chat => `
                <div class="chat-item">
                    ${chat.username}: ${chat.members.toLocaleString()} ${langData[currentLang].participants}
                </div>
            `).join('');
    }

    // Attach event listener to slider input
    chatRange.addEventListener('input', updateStats);

    // Language change handler
    function changeLanguage(lang) {
        if (langData[lang]) {
            currentLang = lang;

            // Update all text based on selected language
            title.textContent = langData[currentLang].title;
            subtitle.textContent = langData[currentLang].subtitle;
            labelRange.textContent = langData[currentLang].labelRange;
            labelChats.textContent = langData[currentLang].outputChats;
            labelUsers.textContent = langData[currentLang].outputUsers;
            labelPrice.textContent = langData[currentLang].outputPrice;
            labelDiscount.textContent = langData[currentLang].discountTip;

            // Re-render the statistics based on current slider value, keeping the user's choice
            updateStats();
        }
    }

</script>
</body>
</html>